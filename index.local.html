<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pool Tracker - Local</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Load local config -->
    <script src="config.js"></script>
    <!-- test-credentials.js disabled for debugging -->
    <script>
        // Prevent multiple initializations
        let isInitializing = false;
        
        // Wait for DOM and config to be ready
        function initAppWhenReady() {
            // Prevent running multiple times
            if (isInitializing || window.__appInitialized) {
                return;
            }
            isInitializing = true;
            
            // Check if config is loaded
            if (typeof window.SUPABASE_URL === 'undefined' || typeof window.SUPABASE_ANON_KEY === 'undefined') {
                // Config not loaded yet, wait a bit and try again
                isInitializing = false;
                setTimeout(initAppWhenReady, 50);
                return;
            }

            // Test credentials disabled for debugging
            console.log('‚ÑπÔ∏è Auto-login disabled - manual login only');

            // Initialize Supabase client
            const SUPABASE_URL = window.SUPABASE_URL || '';
            const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '';

            // Debug: Log config values (remove in production)
            console.log('SUPABASE_URL:', SUPABASE_URL ? 'Set' : 'Missing');
            console.log('SUPABASE_ANON_KEY:', SUPABASE_ANON_KEY ? 'Set' : 'Missing');

            // Check if config is set
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes('YOUR_') || SUPABASE_ANON_KEY.includes('YOUR_')) {
                if (document.getElementById('config-warning')) {
                    document.getElementById('config-warning').classList.remove('hidden');
                }
                if (document.getElementById('app')) {
                    document.getElementById('app').innerHTML = `
                        <div class="bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded">
                            <strong>Configuration Error:</strong> Please edit <code>config.js</code> and add your Supabase credentials.
                            <br><br>
                            <strong>Debug Info:</strong>
                            <ul class="list-disc list-inside mt-2 space-y-1 text-sm">
                                <li>SUPABASE_URL: ${SUPABASE_URL ? 'Found' : 'Missing'}</li>
                                <li>SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY ? 'Found' : 'Missing'}</li>
                                <li>Config file path: <code>config.js</code> (should be in same directory)</li>
                            </ul>
                            <br>
                            <strong>Steps:</strong>
                            <ol class="list-decimal list-inside mt-2 space-y-1">
                                <li>Open <code>config.js</code> in this directory</li>
                                <li>Replace <code>YOUR_SUPABASE_URL_HERE</code> with your Supabase project URL</li>
                                <li>Replace <code>YOUR_SUPABASE_ANON_KEY_HERE</code> with your Supabase anonymous key</li>
                                <li>Refresh this page</li>
                            </ol>
                            <br>
                            <p class="text-sm">You can find these values in your Supabase dashboard under Settings > API</p>
                            <p class="text-sm mt-2">If config.js exists and has values, check the browser console for errors loading the file.</p>
                        </div>
                    `;
                }
                return; // Stop execution if config is missing
            }

            // Continue with app initialization
            try {
                initializeApp(SUPABASE_URL, SUPABASE_ANON_KEY);
                window.__appInitialized = true;
            } catch (error) {
                console.error('Error initializing app:', error);
                // Fallback: show auth view if initialization fails
                setTimeout(() => {
                    const authViewEl = document.getElementById('auth-view');
                    if (authViewEl) {
                        authViewEl.classList.remove('hidden');
                    }
                }, 100);
            }
        }

        // Start initialization when DOM is ready - but only once
        if (!window.__initStarted) {
            window.__initStarted = true;
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initAppWhenReady);
            } else {
                // DOM already loaded
                initAppWhenReady();
            }
        }
        
        // Safety net: Ensure loading overlay is hidden and auth view is shown if nothing else happens
        setTimeout(() => {
            const loadingOverlay = document.getElementById('loading-overlay');
            const authView = document.getElementById('auth-view');
            const appView = document.getElementById('app-view');
            
            if (loadingOverlay && !loadingOverlay.classList.contains('hidden')) {
                console.warn('Loading overlay still visible after 1 second, hiding it');
                loadingOverlay.classList.add('hidden');
            }
            
            if (authView && appView) {
                const authHidden = authView.classList.contains('hidden');
                const appHidden = appView.classList.contains('hidden');
                if (authHidden && appHidden) {
                    console.warn('Both views are hidden! Showing auth view as fallback.');
                    authView.classList.remove('hidden');
                    appView.classList.add('hidden');
                }
            }
        }, 1000);
    </script>
    <style>
        /* Custom styles for loading states and animations */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="bg-gray-800 shadow-sm rounded-lg mb-6 p-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-gray-100 flex items-center gap-2">
                    <img src="Media/Coin Pool Cleaned Up.svg" alt="Pool Coins" class="w-8 h-8">
                    Pool Tracker
                </h1>
                <div id="auth-section" class="flex items-center gap-4">
                    <!-- Auth buttons will be inserted here -->
                </div>
            </div>
        </header>

        <!-- Configuration Warning (only shown if config is missing) -->
        <div id="config-warning" class="hidden bg-yellow-900 border border-yellow-700 text-yellow-200 px-4 py-3 rounded mb-4">
            <strong>Configuration Required:</strong> Please edit <code>config.js</code> and add your Supabase URL and Anon Key.
        </div>

        <!-- Authentication View -->
        <div id="auth-view" class="hidden">
            <div class="bg-gray-800 rounded-lg shadow-md p-8 max-w-md mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-gray-100">Welcome to Pool Tracker</h2>
                    <button id="clear-session-btn" 
                            class="text-xs px-3 py-1 bg-red-900 text-red-200 rounded hover:bg-red-800 transition"
                            title="Clear cached session if you're having login issues">
                        üßπ Clear Session
                    </button>
                </div>
                
                <!-- Tabs -->
                <div class="flex border-b border-gray-700 mb-6">
                    <button id="signin-tab" class="flex-1 py-2 px-4 text-center font-medium text-blue-400 border-b-2 border-blue-400">
                        Sign In
                    </button>
                    <button id="signup-tab" class="flex-1 py-2 px-4 text-center font-medium text-gray-400 hover:text-gray-300">
                        Sign Up
                    </button>
                </div>

                <!-- Sign In Form -->
                <div id="signin-form" class="space-y-4">
                    <div>
                        <label for="signin-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                        <input type="email" id="signin-email" 
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-400"
                               placeholder="your@email.com" required>
                    </div>
                    <div>
                        <label for="signin-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="signin-password" 
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-400"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button id="signin-btn" 
                            class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                        Sign In
                    </button>
                    <div id="signin-error" class="text-red-600 text-sm mt-2 hidden"></div>
                    
                    <!-- Divider -->
                    <div class="relative my-4">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-600"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-gray-800 text-gray-400">Or</span>
                        </div>
                    </div>
                    
                    <!-- Google Sign In Button -->
                    <button id="google-signin-btn" 
                            class="w-full flex items-center justify-center gap-3 bg-gray-700 border-2 border-gray-600 text-gray-200 py-2 px-4 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition">
                        <svg class="w-5 h-5" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Sign in with Google
                    </button>
                </div>

                <!-- Sign Up Form -->
                <div id="signup-form" class="space-y-4 hidden">
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                        <input type="email" id="signup-email" 
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-400"
                               placeholder="your@email.com" required>
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="signup-password" 
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-400"
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (min. 6 characters)" required minlength="6">
                    </div>
                    <div>
                        <label for="signup-display-name" class="block text-sm font-medium text-gray-300 mb-1">Display Name (Optional)</label>
                        <input type="text" id="signup-display-name" 
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-400"
                               placeholder="Your Name">
                    </div>
                    <button id="signup-btn" 
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition">
                        Sign Up
                    </button>
                    <div id="signup-error" class="text-red-600 text-sm mt-2 hidden"></div>
                    
                    <!-- Divider -->
                    <div class="relative my-4">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-gray-600"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-gray-800 text-gray-400">Or</span>
                        </div>
                    </div>
                    
                    <!-- Google Sign Up Button -->
                    <button id="google-signup-btn" 
                            class="w-full flex items-center justify-center gap-3 bg-gray-700 border-2 border-gray-600 text-gray-200 py-2 px-4 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition">
                        <svg class="w-5 h-5" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Sign up with Google
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Application View -->
        <div id="app-view" class="hidden">
            <!-- User Info Card -->
            <div class="bg-gray-800 rounded-lg shadow-md p-4 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-400">Logged in as</p>
                        <p id="user-email" class="text-lg font-semibold text-gray-100"></p>
                        <p id="user-display-name" class="text-sm text-gray-400"></p>
                    </div>
                    <button id="logout-btn" 
                            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition">
                        Logout
                    </button>
                </div>
            </div>

            <!-- Pools Section -->
            <div class="bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-100">My Pools</h2>
                    <button id="create-pool-btn" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition">
                        + Create Pool
                    </button>
                </div>
                <div id="pools-list" class="space-y-3">
                    <p class="text-gray-400 text-center py-8">No pools yet. Create your first pool to get started!</p>
                </div>
            </div>

            <!-- Standings Section -->
            <div class="bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-100 mb-4">Standings</h2>
                <div id="standings-list" class="space-y-2">
                    <p class="text-gray-400 text-center py-8">Select a pool to view standings.</p>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg p-6">
                <div class="flex items-center gap-3">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-500"></div>
                    <span class="text-gray-200">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Create Pool Modal -->
        <div id="create-pool-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-md w-full mx-4 border border-gray-700">
                <h3 class="text-xl font-semibold text-gray-100 mb-4">Create New Pool</h3>
                <div class="space-y-4">
                    <div>
                        <label for="pool-name-input" class="block text-sm font-medium text-gray-300 mb-1">Pool Name *</label>
                        <input type="text" id="pool-name-input" 
                               class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-400"
                               placeholder="Enter pool name" required>
                    </div>
                    <div>
                        <label for="pool-description-input" class="block text-sm font-medium text-gray-300 mb-1">Description (Optional)</label>
                        <textarea id="pool-description-input" rows="3"
                                  class="w-full px-4 py-2 bg-gray-700 border border-gray-600 text-gray-100 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-gray-400 resize-none"
                                  placeholder="Enter pool description"></textarea>
                    </div>
                    <div class="flex gap-3 justify-end pt-2">
                        <button id="cancel-pool-btn" 
                                class="px-4 py-2 bg-gray-700 text-gray-200 rounded-lg hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition">
                            Cancel
                        </button>
                        <button id="submit-pool-btn" 
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-800 transition">
                            Create Pool
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function initializeApp(SUPABASE_URL, SUPABASE_ANON_KEY) {
        // Prevent multiple initializations of the app
        if (window.__appInitialized) {
            console.warn('App already initialized, skipping...');
            return;
        }
        
        // Create Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // State management
        let currentUser = null;
        let currentPools = [];

        // DOM Elements - get them when needed, not at initialization
        // (They might not exist yet when this function runs)
        function getAuthView() { return document.getElementById('auth-view'); }
        function getAppView() { return document.getElementById('app-view'); }
        
        const authView = getAuthView();
        const appView = getAppView();
        const authSection = document.getElementById('auth-section');
        const signinTab = document.getElementById('signin-tab');
        const signupTab = document.getElementById('signup-tab');
        const signinForm = document.getElementById('signin-form');
        const signupForm = document.getElementById('signup-form');
        const signinBtn = document.getElementById('signin-btn');
        const signupBtn = document.getElementById('signup-btn');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const googleSignupBtn = document.getElementById('google-signup-btn');
        const signinEmail = document.getElementById('signin-email');
        const signinPassword = document.getElementById('signin-password');
        const signupEmail = document.getElementById('signup-email');
        const signupPassword = document.getElementById('signup-password');
        const signupDisplayName = document.getElementById('signup-display-name');
        const signinError = document.getElementById('signin-error');
        const signupError = document.getElementById('signup-error');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmail = document.getElementById('user-email');
        const userDisplayName = document.getElementById('user-display-name');
        const createPoolBtn = document.getElementById('create-pool-btn');
        const poolsList = document.getElementById('pools-list');
        const standingsList = document.getElementById('standings-list');
        const loadingOverlay = document.getElementById('loading-overlay');
        const cancelPoolBtn = document.getElementById('cancel-pool-btn');
        const submitPoolBtn = document.getElementById('submit-pool-btn');
        const poolNameInput = document.getElementById('pool-name-input');

        // Utility Functions
        function showLoading() {
            if (loadingOverlay) loadingOverlay.classList.remove('hidden');
        }

        function hideLoading() {
            if (loadingOverlay) loadingOverlay.classList.add('hidden');
        }

        function showError(element, message) {
            if (!element) return;
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        // Tab Switching
        if (signinTab && signupTab) {
            signinTab.addEventListener('click', () => {
                signinTab.classList.add('text-blue-400', 'border-b-2', 'border-blue-400');
                signinTab.classList.remove('text-gray-400');
                signupTab.classList.remove('text-blue-400', 'border-b-2', 'border-blue-400');
                signupTab.classList.add('text-gray-400');
                signinForm.classList.remove('hidden');
                signupForm.classList.add('hidden');
            });

            signupTab.addEventListener('click', () => {
                signupTab.classList.add('text-blue-400', 'border-b-2', 'border-blue-400');
                signupTab.classList.remove('text-gray-400');
                signinTab.classList.remove('text-blue-400', 'border-b-2', 'border-blue-400');
                signinTab.classList.add('text-gray-400');
                signupForm.classList.remove('hidden');
                signinForm.classList.add('hidden');
            });
        }

        // No longer needed - removed for simplicity

        async function loadUserProfile() {
            if (!supabase || !currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error loading user profile:', error);
                }

                // If user profile doesn't exist (e.g., from OAuth), create it
                if (!data && currentUser) {
                    const displayName = currentUser.user_metadata?.display_name || 
                                      currentUser.user_metadata?.full_name || 
                                      currentUser.user_metadata?.name || 
                                      null;
                    
                    const { error: insertError } = await supabase
                        .from('users')
                        .insert({
                            id: currentUser.id,
                            email: currentUser.email,
                            display_name: displayName
                        });

                    if (insertError && insertError.code !== '23505') { // Ignore duplicate key errors
                        console.error('Error creating user profile:', insertError);
                    }

                    // Update display
                    if (userEmail) {
                        userEmail.textContent = currentUser.email;
                    }
                    if (userDisplayName) {
                        userDisplayName.textContent = displayName ? `(${displayName})` : '';
                    }
                } else if (data && userEmail) {
                    userEmail.textContent = data.email || currentUser.email;
                    if (userDisplayName) {
                        userDisplayName.textContent = data.display_name ? `(${data.display_name})` : '';
                    }
                } else if (userEmail) {
                    userEmail.textContent = currentUser.email;
                }
            } catch (error) {
                console.error('Error loading user profile:', error);
                if (userEmail) userEmail.textContent = currentUser.email;
            }
        }

        // SIMPLE SIGN IN - No fancy stuff, just basic Supabase auth
        async function signIn() {
            const email = signinEmail?.value?.trim();
            const password = signinPassword?.value;

            if (!email || !password) {
                showError(signinError, 'Please enter email and password');
                return;
            }

            if (!supabase) {
                showError(signinError, 'Not connected to database');
                return;
            }

            if (signinBtn) signinBtn.disabled = true;
            showError(signinError, 'Signing in...');

            try {
                // First, check if there's an existing session and clear it AGGRESSIVELY
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    console.log('Clearing existing session before login');
                    
                    // Use the SAME aggressive clearing as the Clear Session button
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        const key = localStorage.key(i);
                        if (key) localStorage.removeItem(key);
                    }
                    sessionStorage.clear();
                    await supabase.auth.signOut();
                    
                    // Give it a moment to clear
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                // Now sign in
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                
                if (error) {
                    throw error;
                }
                
                // Success - the onAuthStateChange listener will handle the rest
                if (signinEmail) signinEmail.value = '';
                if (signinPassword) signinPassword.value = '';
                
            } catch (error) {
                console.error('Sign in error:', error);
                let msg = 'Sign in failed';
                if (error.message) msg = error.message;
                if (error.status === 429) msg = 'Too many attempts. Wait a few minutes.';
                showError(signinError, msg);
                if (signinBtn) signinBtn.disabled = false;
            }
        }

        async function signUp() {
            if (!supabase) {
                showError(signupError, 'Supabase not configured');
                return;
            }

            const email = signupEmail.value.trim();
            const password = signupPassword.value;
            const displayName = signupDisplayName.value.trim();

            if (!email || !password) {
                showError(signupError, 'Please enter email and password');
                return;
            }

            if (password.length < 6) {
                showError(signupError, 'Password must be at least 6 characters');
                return;
            }

            showLoading();
            try {
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            display_name: displayName || null
                        }
                    }
                });

                if (error) throw error;

                // Create user profile
                if (data.user) {
                    const { error: profileError } = await supabase
                        .from('users')
                        .insert({
                            id: data.user.id,
                            email: data.user.email,
                            display_name: displayName || null
                        });

                    if (profileError && profileError.code !== '23505') {
                        console.error('Error creating user profile:', profileError);
                    }
                }

                showError(signupError, 'Account created! Please check your email to verify your account, then sign in.', 'text-green-600');
                signupEmail.value = '';
                signupPassword.value = '';
                signupDisplayName.value = '';
                
                // Switch to sign in tab
                setTimeout(() => {
                    if (signinTab) signinTab.click();
                }, 2000);
            } catch (error) {
                showError(signupError, error.message || 'Sign up failed');
            } finally {
                hideLoading();
            }
        }

        async function signInWithGoogle() {
            if (!supabase) {
                showError(signinError, 'Supabase not configured');
                return;
            }

            showLoading();
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + window.location.pathname
                    }
                });

                if (error) throw error;
                // Note: The OAuth flow will redirect, so we don't need to handle the response here
            } catch (error) {
                hideLoading();
                showError(signinError, error.message || 'Google sign in failed');
            }
        }

        // SIMPLE SIGN OUT
        async function signOut() {
            if (supabase) {
                await supabase.auth.signOut();
            }
            // The onAuthStateChange listener will handle the rest
        }

        function showAuthView() {
            console.log('showAuthView called');
            const authViewEl = document.getElementById('auth-view');
            const appViewEl = document.getElementById('app-view');
            console.log('authViewEl:', authViewEl);
            console.log('appViewEl:', appViewEl);
            if (authViewEl) {
                authViewEl.classList.remove('hidden');
                console.log('Auth view shown - classList:', authViewEl.classList.toString());
            } else {
                console.error('auth-view element not found!');
            }
            if (appViewEl) {
                appViewEl.classList.add('hidden');
                console.log('App view hidden - classList:', appViewEl.classList.toString());
            } else {
                console.error('app-view element not found!');
            }
        }

        function showAppView() {
            console.log('showAppView called');
            const authViewEl = document.getElementById('auth-view');
            const appViewEl = document.getElementById('app-view');
            if (authViewEl) authViewEl.classList.add('hidden');
            if (appViewEl) {
                appViewEl.classList.remove('hidden');
                console.log('App view shown');
                loadPools();
            } else {
                console.error('app-view element not found!');
            }
        }

        // Pool Management Functions
        async function loadPools() {
            if (!supabase || !currentUser) return;

            showLoading();
            try {
                const { data, error } = await supabase
                    .from('pool_members')
                    .select(`
                        pool_id,
                        role,
                        joined_at,
                        pools (
                            id,
                            name,
                            description,
                            status,
                            created_at
                        )
                    `)
                    .eq('user_id', currentUser.id)
                    .eq('pools.status', 'active')
                    .order('joined_at', { ascending: false });

                if (error) throw error;

                currentPools = data || [];
                renderPools();
            } catch (error) {
                console.error('Error loading pools:', error);
                if (poolsList) {
                    // Check if it's a permission/access error vs a real database error
                    const errorMessage = error.message || '';
                    if (errorMessage.includes('permission') || errorMessage.includes('PGRST') || errorMessage.includes('JWT')) {
                        poolsList.innerHTML = '<p class="text-red-400 text-center py-4">Error loading pools. Please check your database setup and permissions.</p>';
                    } else {
                        // For other errors, show a more user-friendly message
                        poolsList.innerHTML = '<p class="text-gray-400 text-center py-8">No pools joined or created yet. Click "Create Pool" to get started!</p>';
                    }
                }
            } finally {
                hideLoading();
            }
        }

        function renderPools() {
            if (!poolsList) return;
            
            if (currentPools.length === 0) {
                poolsList.innerHTML = '<p class="text-gray-400 text-center py-8">No pools joined or created yet. Click "Create Pool" to get started!</p>';
                return;
            }

            poolsList.innerHTML = currentPools.map(member => {
                const pool = member.pools;
                return `
                    <div class="border border-gray-700 rounded-lg p-4 hover:bg-gray-700 transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-100">${escapeHtml(pool.name)}</h3>
                                ${pool.description ? `<p class="text-sm text-gray-300 mt-1">${escapeHtml(pool.description)}</p>` : ''}
                                <div class="flex gap-2 mt-2">
                                    <span class="text-xs px-2 py-1 bg-blue-900 text-blue-200 rounded">${member.role}</span>
                                    <span class="text-xs text-gray-400">Joined ${formatDate(member.joined_at)}</span>
                                </div>
                            </div>
                            <button onclick="viewPool('${pool.id}')" 
                                    class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition">
                                View
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewPool(poolId) {
            // Placeholder for pool view functionality
            alert('Pool view functionality coming soon! Pool ID: ' + poolId);
        }

        function showCreatePoolModal() {
            const modal = document.getElementById('create-pool-modal');
            const nameInput = document.getElementById('pool-name-input');
            const descriptionInput = document.getElementById('pool-description-input');
            
            if (modal) {
                modal.classList.remove('hidden');
                // Clear inputs
                if (nameInput) nameInput.value = '';
                if (descriptionInput) descriptionInput.value = '';
                // Focus on name input
                setTimeout(() => {
                    if (nameInput) nameInput.focus();
                }, 100);
            }
        }

        function hideCreatePoolModal() {
            const modal = document.getElementById('create-pool-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        async function createPool() {
            const nameInput = document.getElementById('pool-name-input');
            const descriptionInput = document.getElementById('pool-description-input');
            
            if (!nameInput) return;
            
            const name = nameInput.value.trim();
            if (!name) {
                nameInput.focus();
                return;
            }

            const description = descriptionInput ? descriptionInput.value.trim() : null;

            if (!supabase || !currentUser) {
                alert('Error: Not authenticated or Supabase not configured');
                return;
            }

            hideCreatePoolModal();
            showLoading();
            
            let createdPoolId = null;
            
            try {
                // Step 0: Ensure user profile exists (should already exist, but double-check)
                const { data: userProfile, error: profileError } = await supabase
                    .from('users')
                    .select('id')
                    .eq('id', currentUser.id)
                    .single();
                
                if (profileError && profileError.code !== 'PGRST116') {
                    console.warn('User profile check failed:', profileError);
                    // Try to create the profile
                    const { error: createProfileError } = await supabase
                        .from('users')
                        .insert({
                            id: currentUser.id,
                            email: currentUser.email,
                            display_name: currentUser.user_metadata?.display_name || null
                        });
                    
                    if (createProfileError && createProfileError.code !== '23505') {
                        console.error('Failed to create user profile:', createProfileError);
                        throw new Error('User profile issue. Please try logging out and back in.');
                    }
                }
                
                // Step 1: Create the pool
                console.log('Creating pool:', name);
                const { data: pool, error: poolError } = await supabase
                    .from('pools')
                    .insert({
                        name: name,
                        description: description || null,
                        status: 'active'
                    })
                    .select()
                    .single();

                if (poolError) {
                    console.error('Error creating pool:', poolError);
                    throw new Error(`Failed to create pool: ${poolError.message || poolError.code || 'Unknown error'}`);
                }

                if (!pool || !pool.id) {
                    throw new Error('Pool was created but no ID was returned');
                }

                createdPoolId = pool.id;
                console.log('Pool created successfully with ID:', createdPoolId);

                // Step 2: Add creator as manager
                console.log('Adding user as manager to pool:', createdPoolId);
                const { data: memberData, error: memberError } = await supabase
                    .from('pool_members')
                    .insert({
                        pool_id: createdPoolId,
                        user_id: currentUser.id,
                        role: 'manager'
                    })
                    .select()
                    .single();

                if (memberError) {
                    console.error('Error adding user as manager:', memberError);
                    // Clean up: delete the orphaned pool
                    console.log('Cleaning up orphaned pool:', createdPoolId);
                    await supabase
                        .from('pools')
                        .delete()
                        .eq('id', createdPoolId);
                    
                    // Provide helpful error message
                    let errorMsg = `Failed to add you as manager: ${memberError.message || memberError.code || 'Unknown error'}`;
                    if (memberError.code === '42501' || memberError.message?.includes('permission')) {
                        errorMsg += '\n\nThis might be a Row Level Security (RLS) policy issue. Please check your database policies.';
                    }
                    throw new Error(errorMsg);
                }

                console.log('Successfully added user as manager');
                
                // Step 3: Reload pools list
                await loadPools();
                console.log('Pool creation completed successfully');
                
            } catch (error) {
                console.error('Error in createPool:', error);
                // Re-show the modal so user can try again
                showCreatePoolModal();
                // Restore the input values
                if (nameInput) nameInput.value = name;
                if (descriptionInput) descriptionInput.value = description || '';
                
                // Show detailed error message
                const errorMessage = error.message || 'Unknown error occurred';
                alert(`Error creating pool:\n\n${errorMessage}\n\nPlease try again.`);
            } finally {
                hideLoading();
            }
        }

        // Utility Functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        // CLEAR SESSION - Nukes everything and reloads
        function clearSession() {
            // Clear all localStorage keys
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key) localStorage.removeItem(key);
            }
            sessionStorage.clear();
            window.location.reload();
        }
        
        // Event Listeners
        if (signinBtn) signinBtn.addEventListener('click', signIn);
        if (signupBtn) signupBtn.addEventListener('click', signUp);
        if (googleSigninBtn) googleSigninBtn.addEventListener('click', signInWithGoogle);
        if (googleSignupBtn) googleSignupBtn.addEventListener('click', signInWithGoogle);
        if (logoutBtn) logoutBtn.addEventListener('click', signOut);
        if (createPoolBtn) createPoolBtn.addEventListener('click', showCreatePoolModal);
        if (cancelPoolBtn) cancelPoolBtn.addEventListener('click', hideCreatePoolModal);
        if (submitPoolBtn) submitPoolBtn.addEventListener('click', createPool);
        
        // Clear session button
        const clearSessionBtn = document.getElementById('clear-session-btn');
        if (clearSessionBtn) clearSessionBtn.addEventListener('click', clearSession);
        
        // Allow Enter key to submit pool creation form
        if (poolNameInput) {
            poolNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    createPool();
                }
            });
        }
        
        // Close modal when clicking outside
        const createPoolModal = document.getElementById('create-pool-modal');
        if (createPoolModal) {
            createPoolModal.addEventListener('click', (e) => {
                if (e.target === createPoolModal) {
                    hideCreatePoolModal();
                }
            });
        }

        // Allow Enter key to submit forms
        if (signinPassword) {
            signinPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') signIn();
            });
        }
        if (signupPassword) {
            signupPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') signUp();
            });
        }

        // AUTH STATE CHANGE LISTENER - This is the key to making Supabase auth work
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth event:', event);
            
            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                await loadUserProfile();
                showAppView();
                if (signinBtn) signinBtn.disabled = false;
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                currentPools = [];
                showAuthView();
            }
        });

        // INITIALIZE - For local dev, always start fresh to avoid stale sessions
        (async function initApp() {
            console.log('Initializing app...');
            
            // For LOCAL DEVELOPMENT: Clear any cached sessions on page load
            // This prevents stale sessions after server restarts
            const isLocalDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            if (isLocalDev) {
                console.log('üßπ Local dev mode: Clearing any cached sessions on startup');
                
                // Use the SAME aggressive clearing as the Clear Session button
                // Clear all localStorage
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key) localStorage.removeItem(key);
                }
                // Clear sessionStorage
                sessionStorage.clear();
                
                // Call signOut too for good measure
                await supabase.auth.signOut();
                
                showAuthView();
                hideLoading();
            } else {
                // PRODUCTION: Try to restore session if valid
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    
                    if (session) {
                        console.log('Found cached session, validating...');
                        const { data: { user }, error: userError } = await supabase.auth.getUser();
                        
                        if (userError || !user) {
                            console.warn('Cached session is invalid, clearing it');
                            await supabase.auth.signOut();
                            showAuthView();
                        } else {
                            console.log('Session is valid, logging in');
                            currentUser = user;
                            await loadUserProfile();
                            showAppView();
                        }
                    } else {
                        showAuthView();
                    }
                } catch (err) {
                    console.error('Initialization error:', err);
                    showAuthView();
                }
                hideLoading();
            }
        })();
        
        // Mark app as initialized
        window.__appInitialized = true;
        console.log('App initialization complete');
        } // End of initializeApp function
    </script>
</body>
</html>

